import React, { useState, useCallback } from 'react';

// Spinner Component
const Spinner = () => (
    <div className="spinner border-4 border-white/20 w-12 h-12 rounded-full border-l-pink-500 animate-spin"></div>
);

// UploadBox Component
const UploadBox = ({ id, onFileUpload, imagePreview, label }) => {
    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file) {
            onFileUpload(file);
        }
    };

    const handleDrop = useCallback((event) => {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-pink-500', 'bg-slate-800');
        const file = event.dataTransfer.files[0];
        if (file) {
            onFileUpload(file);
        }
    }, [onFileUpload]);

    const handleDragOver = (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.add('border-pink-500', 'bg-slate-800');
    };

    const handleDragLeave = (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.currentTarget.classList.remove('border-pink-500', 'bg-slate-800');
    };

    return (
        <label
            htmlFor={id}
            onDrop={handleDrop}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            className={`upload-box relative w-full aspect-square bg-slate-800/50 border-2 border-dashed rounded-2xl flex items-center justify-center text-center cursor-pointer transition-all duration-300 hover:border-pink-500 hover:bg-slate-800 ${imagePreview ? 'border-pink-500' : 'border-slate-600'}`}
            style={{ backgroundImage: `url(${imagePreview || ''})`, backgroundSize: 'cover', backgroundPosition: 'center' }}
        >
            <div className={`upload-ui absolute inset-0 flex flex-col items-center justify-center bg-slate-800/50 rounded-2xl p-4 transition-opacity duration-300 ${imagePreview ? 'opacity-0 hover:opacity-100' : ''}`}>
                <svg className="w-12 h-12 text-slate-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <h2 className="text-lg font-semibold text-slate-200">{label}</h2>
                <p className="text-sm text-slate-400">Drag & drop or click</p>
            </div>
            <input type="file" id={id} className="hidden" accept="image/png, image/jpeg, image/webp" onChange={handleFileChange} />
        </label>
    );
};

// Main App Component
export default function App() {
    const [image1, setImage1] = useState({ file: null, preview: null, base64: null });
    const [image2, setImage2] = useState({ file: null, preview: null, base64: null });
    const [resultImage, setResultImage] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    const API_KEY = ""; // Use "" for environments with built-in auth
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;

    const handleFileUpload = (file, imageSetter) => {
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            imageSetter({
                file: file,
                preview: URL.createObjectURL(file),
                base64: reader.result,
            });
        };
        reader.readAsDataURL(file);
    };

    const makeApiCallWithRetry = useCallback(async (payload, retries = 3, delay = 1000) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const imageData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (imageData) {
                    return imageData;
                } else {
                    console.warn("API response missing image data:", result);
                    throw new Error("Invalid API response structure or content filtered.");
                }
            } catch (error) {
                console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`, error);
                if (i < retries - 1) {
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                } else {
                    throw error;
                }
            }
        }
        return null;
    }, [API_URL]);

    const generateHugImage = async () => {
        if (!image1.base64 || !image2.base64) return;

        setIsLoading(true);
        setError(null);
        setResultImage(null);

        const [, data1] = image1.base64.split(',');
        const mimeType1 = image1.file.type;
        const [, data2] = image2.base64.split(',');
        const mimeType2 = image2.file.type;

        const payload = {
            contents: [{
                parts: [
                    { text: "You will be provided with two images. Your task is to create a new, single, photorealistic image where the main subjects from both images are seen hugging each other. Maintain their original appearance, characteristics, and style as much as possible in the final composition. The background should be neutral and soft-focused." },
                    { inlineData: { mimeType: mimeType1, data: data1 } },
                    { inlineData: { mimeType: mimeType2, data: data2 } },
                ],
            }],
            generationConfig: {
                responseModalities: ["IMAGE"],
            },
        };

        try {
            const generatedData = await makeApiCallWithRetry(payload);
            if (generatedData) {
                setResultImage(`data:image/png;base64,${generatedData}`);
            } else {
                throw new Error("No image data received from API after retries.");
            }
        } catch (err) {
            console.error("Error during image generation:", err);
            setError("Oops! Something went wrong. Please try again.");
        } finally {
            setIsLoading(false);
        }
    };

    const handleStartOver = () => {
        setImage1({ file: null, preview: null, base64: null });
        setImage2({ file: null, preview: null, base64: null });
        setResultImage(null);
        setIsLoading(false);
        setError(null);
    };

    const isGenerateDisabled = !image1.file || !image2.file || isLoading;
    const showUploadView = !isLoading && !resultImage && !error;
    const showResultView = isLoading || resultImage || error;

    return (
        <div className="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4 font-sans">
            <div className="container mx-auto max-w-4xl w-full">
                <header className="text-center mb-10">
                    <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 to-violet-500 text-transparent bg-clip-text">MAUSI.AI</h1>
                    <p className="text-slate-400 mt-3 text-lg">Upload two images, and watch the magic happen!</p>
                </header>

                <main className="w-full">
                    {showUploadView && (
                        <div id="upload-view" className="animate-fadeIn">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <UploadBox id="image-upload-1" onFileUpload={(file) => handleFileUpload(file, setImage1)} imagePreview={image1.preview} label="Upload Image 1" />
                                <UploadBox id="image-upload-2" onFileUpload={(file) => handleFileUpload(file, setImage2)} imagePreview={image2.preview} label="Upload Image 2" />
                            </div>
                            <div className="text-center">
                                <button onClick={generateHugImage} disabled={isGenerateDisabled} className="bg-pink-600 text-white font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-pink-700 transition-all duration-300 disabled:bg-slate-700 disabled:text-slate-400 disabled:cursor-not-allowed">
                                    {isLoading ? 'Generating...' : 'Generate Hug'}
                                </button>
                            </div>
                        </div>
                    )}

                    {showResultView && (
                        <div id="result-view" className="animate-fadeIn">
                            <div className="flex flex-col items-center">
                                {isLoading && <h2 className="text-3xl font-semibold mb-6 text-slate-300">Generating your hug...</h2>}
                                {!isLoading && resultImage && <h2 className="text-3xl font-semibold mb-6 text-slate-300">Here they are!</h2>}
                                
                                <div className="relative w-full max-w-xl aspect-square bg-slate-800 rounded-2xl overflow-hidden shadow-lg flex items-center justify-center">
                                    {isLoading && <Spinner />}
                                    {resultImage && <img src={resultImage} alt="AI generated hug" className="w-full h-full object-contain" />}
                                </div>
                            </div>
                            
                            {error && (
                                <div className="mt-6 text-center bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg max-w-xl mx-auto">
                                    <p><strong>{error}</strong></p>
                                </div>
                            )}

                            <div className="mt-10 text-center flex items-center justify-center gap-4 flex-wrap">
                                {resultImage && !isLoading && (
                                    <a href={resultImage} download="mausi-ai-hug.png" className="bg-emerald-500 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-emerald-600 transition-all duration-300">
                                        Download Image
                                    </a>
                                )}
                                <button onClick={handleStartOver} className="bg-slate-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-slate-700 transition-all duration-300">
                                    Start Over
                                </button>
                            </div>
                        </div>
                    )}
                </main>
            </div>
        </div>
    );
}
